<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Storage CRM</title>
    <style>
        body {
            font-family: monospace;
            background: #1a1a1a;
            color: #fff;
            padding: 20px;
        }
        .section {
            background: #2a2a2a;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .key {
            color: #4a9eff;
            font-weight: bold;
        }
        .value {
            color: #50fa7b;
        }
        pre {
            background: #000;
            padding: 10px;
            border-radius: 3px;
            overflow-x: auto;
        }
        button {
            background: #4a9eff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #3a8eef;
        }
    </style>
</head>
<body>
    <h1>üîç Diagnostic Storage CRM</h1>

    <div class="section">
        <h2>üìä √âtat du localStorage</h2>
        <div id="storage-info"></div>
    </div>

    <div class="section">
        <h2>üì¶ Donn√©es CRM</h2>
        <div id="crm-data"></div>
    </div>

    <div class="section">
        <h2>üîß Actions</h2>
        <button onclick="exportData()">üíæ Exporter les donn√©es</button>
        <button onclick="location.reload()">üîÑ Rafra√Æchir</button>
    </div>

    <script>
        function displayStorageInfo() {
            const infoDiv = document.getElementById('storage-info');
            let html = '';

            // Liste toutes les cl√©s localStorage
            html += '<p><span class="key">Nombre total de cl√©s:</span> <span class="value">' + localStorage.length + '</span></p>';

            html += '<p><span class="key">Cl√©s pr√©sentes:</span></p><ul>';
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                const size = localStorage.getItem(key)?.length || 0;
                html += `<li>${key} (${size} caract√®res)</li>`;
            }
            html += '</ul>';

            infoDiv.innerHTML = html;
        }

        function displayCRMData() {
            const dataDiv = document.getElementById('crm-data');
            let html = '';

            // V√©rifie crm_pipelines
            const pipelines = localStorage.getItem('crm_pipelines');
            if (pipelines) {
                try {
                    const parsed = JSON.parse(pipelines);
                    html += '<h3>‚úÖ crm_pipelines trouv√©</h3>';
                    html += '<p><span class="key">Nombre de pipelines:</span> <span class="value">' + parsed.length + '</span></p>';

                    parsed.forEach((pipeline, idx) => {
                        html += `<p><span class="key">Pipeline ${idx + 1}:</span> ${pipeline.name}</p>`;
                        html += `<p><span class="key">Nombre de leads:</span> <span class="value">${pipeline.leads?.length || 0}</span></p>`;
                    });

                    html += '<details><summary>Voir le JSON complet</summary>';
                    html += '<pre>' + JSON.stringify(parsed, null, 2) + '</pre>';
                    html += '</details>';
                } catch (e) {
                    html += '<h3>‚ùå Erreur de parsing crm_pipelines</h3>';
                    html += '<p>' + e.message + '</p>';
                    html += '<pre>' + pipelines.substring(0, 500) + '...</pre>';
                }
            } else {
                html += '<h3>‚ùå crm_pipelines NON TROUV√â</h3>';
            }

            // V√©rifie l'ancienne cl√© crm-leads
            const oldLeads = localStorage.getItem('crm-leads');
            if (oldLeads) {
                html += '<h3>‚ö†Ô∏è Ancienne cl√© crm-leads trouv√©e</h3>';
                html += '<p>Cette cl√© contient peut-√™tre vos anciennes donn√©es</p>';
                try {
                    const parsed = JSON.parse(oldLeads);
                    html += '<p><span class="key">Nombre de leads:</span> <span class="value">' + parsed.length + '</span></p>';
                    html += '<details><summary>Voir le JSON complet</summary>';
                    html += '<pre>' + JSON.stringify(parsed, null, 2) + '</pre>';
                    html += '</details>';
                } catch (e) {
                    html += '<p>Erreur de parsing</p>';
                }
            }

            // V√©rifie current pipeline
            const currentPipeline = localStorage.getItem('crm_current_pipeline');
            if (currentPipeline) {
                html += '<p><span class="key">Pipeline actuel:</span> <span class="value">' + currentPipeline + '</span></p>';
            }

            dataDiv.innerHTML = html;
        }

        function exportData() {
            const data = {
                timestamp: new Date().toISOString(),
                localStorage: {}
            };

            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key) {
                    data.localStorage[key] = localStorage.getItem(key);
                }
            }

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `crm-backup-${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);

            alert('‚úÖ Donn√©es export√©es !');
        }

        // Ex√©cute au chargement
        displayStorageInfo();
        displayCRMData();

        // Surveille les changements de localStorage
        window.addEventListener('storage', (e) => {
            console.log('üîî localStorage modifi√©:', e.key, e.newValue);
            displayStorageInfo();
            displayCRMData();
        });

        // Log au rafra√Æchissement
        console.log('üîç Page de debug charg√©e √†', new Date().toISOString());
        console.log('üì¶ localStorage.length:', localStorage.length);
    </script>
</body>
</html>
